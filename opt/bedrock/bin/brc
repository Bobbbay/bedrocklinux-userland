#!/bin/sh
# brc (BedRock Chroot) for Bedrock Linux 1.0alpha3 "Bosco"
# This script will run a command in a chroot

# check for need to print help
if [ -z "$1" ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]
then
	echo "Usage: brc CLIENT_NAME [COMMAND]"
	exit 0
fi

# ensure config file is available
if [ ! -r /opt/bedrock/etc/brclients.conf ]
then
	abort "Cannot read /opt/bedrock/etc/brclients.conf"
fi

CLIENT=$1
shift
CLIENT_PATH="$(awk '/^\['$CLIENT'\]$/{PARSE=1} PARSE==1&&/^path /{print $2;exit}' /opt/bedrock/etc/brclients.conf)"

# ensure brs for children is finished - should have been called by parent brc or init
if [ -z "$BRS_PID" ] || [ -z "$BRS_STARTTIME" ]
then
	if ps -e -o comm | grep -q "^brs$"
	then
		brs $CLIENT
	fi
else
	if ps -e -o pid | grep -q "^\s*$BRS_PID$" && [ "$(cut -d' ' -f22 /proc/$BRS_PID/stat)" = "$BRS_STARTTIME" ]
	then
		echo "brc: Waiting for parent's backgrounded brs to end..."
		while ps -e -o pid | grep -q "^\s*$BRS_PID$"
		do
			sleep .1
		done
	fi
fi

# run brs in the background now, so that it is ready if/when children of this command
# call brc
nohup capchroot -d / "$CLIENT_PATH" -- brs 1>/dev/null 2>/dev/null &
export BRS_PID="$!"
export BRS_STARTTIME="$(cut -d' ' -f22 /proc/$BRS_PID/stat)"

# check pwd is available in client, fall back to / otherwise
PWD=$(pwd)
if [ ! -d "$CLIENT_PATH$PWD" ]
then
	echo "brc WARNING: $PWD not present in $CLIENT, falling back to root directory"
	DIRECTORY="/"
else
	DIRECTORY="$PWD"
fi

if [ -z "$1" ] # check if any command was given
then
	# if no command, assume user wants to run $SHELL
	exec capchroot -d "$DIRECTORY" "$CLIENT_PATH" -- "$(basename $SHELL)"
else
	# command was given, pass along all arguments
	exec capchroot -d "$DIRECTORY" "$CLIENT_PATH" -- "$@"
fi
