#!/bin/sh
# brs (BedRock Setup) for Bedrock Linux 1.0alpha3 "Bosco"
# This script will setup mounts for children of current client

# print help
if [ "$1" = "-h" ] || [ "$1" = "--help" ]
then
	echo "Usage: brs [CLIENTS]"
	echo ""
	echo "If no client is given, will setup all clients.  Otherwise will only"
	echo "set up requested clients."
	exit 0
fi

# ensure config file is available
if [ ! -r /opt/bedrock/etc/brclients.conf ]
then
	abort "Cannot read /opt/bedrock/etc/brclients.conf"
	exit 1
fi

if [ -z "$1" ]
then
	CLIENTS=" $(bri -l | xargs) "
else
	CLIENTS=" $@ "
fi

setup_client(){
	awk '
		/^\[.*\]$/ {
			PARSE=0
		}
		/^\['$1'\]$/ {
			PARSE=1
		}
		/^path[ \t]/ && PARSE==1 {
			if(CLIENT_PATH != ""){
				print "Path set more than once for "'$1'", aborting"
				exit 1
			}
			CLIENT_PATH=$2
			if(system("[ -d "CLIENT_PATH" ]")!=0){
				print $2" is not a directory, aborting"
				exit 1
			}
			if(system("grep -q "CLIENT_PATH" /opt/bedrock/etc/capchroot.allow")!=0){
				print CLIENT_PATH" is not present in /opt/bedrock/etc/capchroot.allow, aborting"
				exit 1
			}
		}
		/^mount[ \t]/ && CLIENT_PATH!="" {
			MOUNT_POINT=CLIENT_PATH$2
			if(system("awk \"{print \\$2}\" /etc/fstab | grep -q \"^"MOUNT_POINT"$\"")!=0){
				print "Mount point "MOUNT_POINT" not available in fstab, aborting"
				exit 1
			}
			if(system("cut -d\" \" -f5 /proc/$$/mountinfo | grep -q \"^"MOUNT_POINT"$\"")!=0){
				if(system("[ -e "$2" ]")!=0){
					print "Mount source "MOUNT_POINT" not present, aborting"
					exit 1
				}
				if(system("[ -e "MOUNT_POINT" ]")!=0){
					if(system("[ $(id -u) = 0 ]")){
						print "WARNING: "MOUNT_POINT" not present, creating"
						if(system("[ -f "$2" ]")){
							system("mkdir -p $(dirname "MOUNT_POINT"); touch "MOUNT_POINT)
						}else if(system("[ -d "$2" ]")){
							system("mkdir -p "MOUNT_POINT)
						}else{
							print MOUNT_POINT" not present, unsure how to create, aborting"
							exit 1
						}
					}else{
						print "WARNING: "MOUNT_POINT" not present, aborting"
					}
				}
				if(system("mount "MOUNT_POINT)!=0){
					1
				}
			}
		}
	' /opt/bedrock/etc/brclients.conf
}

PIDS=""
for CLIENT in $CLIENTS
do
	setup_client "$CLIENT" &
	PIDS="$PIDS $!"
done
for PID in $PIDS
do
	wait $PID
done
